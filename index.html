<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Android Web NFC Reader</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; font-size: 1.5em; color: #2c3e50; }
        
        /* ã‚¹ãƒãƒ›ã§æŠ¼ã—ã‚„ã™ã„ã‚ˆã†ã«ãƒœã‚¿ãƒ³ã‚’å¤§ããèª¿æ•´ */
        button { 
            width: 100%; 
            padding: 18px; 
            margin: 15px 0; 
            background: #3498db; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 18px; 
            font-weight: bold;
            cursor: pointer; 
            transition: background 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        button:active { background: #2980b9; transform: scale(0.98); }
        button:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; }
        
        #log { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 8px; font-family: monospace; height: 200px; overflow-y: scroll; margin-top: 15px; font-size: 13px; line-height: 1.4; }
        
        .result-box { text-align: center; margin-top: 20px; padding: 15px; background: #e8f6f3; border: 2px solid #2ecc71; border-radius: 8px; display: none; }
        .idm-value { font-size: 1.8em; font-weight: bold; color: #27ae60; word-break: break-all; margin: 10px 0; }
        .note { font-size: 0.85em; color: #7f8c8d; margin-top: 5px; background: #fff3cd; padding: 5px; border-radius: 4px; border: 1px solid #ffeeba; color: #856404;}
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“± Android Web NFC</h2>
    <div class="target-info">ã‚¹ãƒãƒ›ã®èƒŒé¢ã«ã‚«ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
    
    <button id="scanBtn">NFCèª­ã¿å–ã‚Šé–‹å§‹</button>
    
    <div id="resultArea" class="result-box">
        <div>æ¤œçŸ¥ã—ãŸIDm (UID)</div>
        <div class="idm-value" id="idmValue">---</div>
        
        <div class="note">
            âš ï¸ Web NFC APIã®åˆ¶ç´„ã«ã‚ˆã‚Šã€Androidãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã¯Suicaç­‰ã®æ®‹é«˜ãƒ‡ãƒ¼ã‚¿(Block Data)ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚<br>
            IDmï¼ˆã‚«ãƒ¼ãƒ‰å›ºæœ‰ç•ªå·ï¼‰ã®ã¿è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
        </div>
    </div>

    <div id="log"></div>
</div>

<script>
    const logEl = document.getElementById('log');
    const scanBtn = document.getElementById('scanBtn');
    let ndef = null;
    let abortController = null;

    // ãƒ­ã‚°è¡¨ç¤ºç”¨
    function log(msg) {
        logEl.innerHTML += `> ${msg}<br>`;
        logEl.scrollTop = logEl.scrollHeight;
        console.log(msg);
    }

    // Web NFC APIã®ã‚µãƒãƒ¼ãƒˆç¢ºèª
    if (!('NDEFReader' in window)) {
        log("âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web NFCã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚<br>Androidã®Chromeã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚");
        scanBtn.disabled = true;
        scanBtn.textContent = "éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™";
    }

    scanBtn.addEventListener('click', async () => {
        // æ—¢ã«ã‚¹ã‚­ãƒ£ãƒ³ä¸­ãªã‚‰åœæ­¢ã™ã‚‹ãƒˆã‚°ãƒ«å‹•ä½œ
        if (abortController) {
            abortController.abort();
            abortController = null;
            scanBtn.textContent = "NFCèª­ã¿å–ã‚Šé–‹å§‹";
            scanBtn.style.background = "#3498db";
            log("ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚");
            return;
        }

        try {
            abortController = new AbortController();
            ndef = new NDEFReader();

            // ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
            await ndef.scan({ signal: abortController.signal });
            
            log("ğŸ“¡ ã‚¹ã‚­ãƒ£ãƒ³ä¸­... ã‚«ãƒ¼ãƒ‰ã‚’èƒŒé¢ã«å¯†ç€ã•ã›ã¦ãã ã•ã„");
            scanBtn.textContent = "ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢";
            scanBtn.style.background = "#e74c3c"; // åœæ­¢ãƒœã‚¿ãƒ³è‰²ã«å¤‰æ›´

            // èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼æ™‚
            ndef.onreadingerror = () => {
                log("âš ï¸ èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: ã‚«ãƒ¼ãƒ‰ã‚’æ­£ã—ãèªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã‹ã–ã—ã¦ãã ã•ã„ã€‚");
            };

            // èª­ã¿å–ã‚ŠæˆåŠŸæ™‚
            ndef.onreading = event => {
                const serialNumber = event.serialNumber; // IDm (xx:xx:xx...)
                const formattedIdm = serialNumber.toUpperCase().replace(/:/g, ' ');
                
                log(`âœ… èª­ã¿å–ã‚ŠæˆåŠŸ! IDm: ${formattedIdm}`);
                
                document.getElementById('idmValue').textContent = formattedIdm;
                document.getElementById('resultArea').style.display = 'block';
                
                // éŸ³ã‚„æŒ¯å‹•ã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆAndroidã®è¨­å®šä¾å­˜ï¼‰
                if (navigator.vibrate) navigator.vibrate(200);
            };

        } catch (error) {
            log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            abortController = null;
            scanBtn.textContent = "NFCèª­ã¿å–ã‚Šé–‹å§‹";
            scanBtn.style.background = "#3498db";
        }
    });
</script>
</body>
</html>
