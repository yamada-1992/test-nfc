<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebUSB FeliCa Reader</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button { width: 100%; padding: 15px; margin: 10px 0; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        #log { background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 4px; font-family: monospace; height: 150px; overflow-y: scroll; margin-top: 10px; font-size: 12px; }
        .result-box { text-align: center; margin-top: 20px; padding: 10px; background: #e8f6f3; border: 1px solid #2ecc71; border-radius: 5px; display: none; }
        .balance { font-size: 2.5em; font-weight: bold; color: #27ae60; }
        .target-info { font-size: 0.8em; color: #7f8c8d; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“¡ WebUSB FeliCa Reader</h2>
    <div class="target-info">Target Service: 0x898F / Block: 0</div>
    
    <button id="connectBtn">PaSoRiã«æ¥ç¶šã—ã¦èª­ã¿å–ã‚‹</button>
    
    <div id="resultArea" class="result-box">
        <div>èª­ã¿å–ã‚Šçµæœ (Big Endian)</div>
        <div class="balance"><span id="balanceValue">---</span></div>
        <div style="font-size:0.8em;">Raw: <span id="rawHex"></span></div>
    </div>

    <div id="log"></div>
</div>

<script>
    let device = null;
    const SONY_VENDOR_ID = 0x054C;
    const RCS380_PRODUCT_ID = 0x06C3;

    // ãƒ­ã‚°è¡¨ç¤ºç”¨
    function log(msg) {
        const el = document.getElementById('log');
        el.innerHTML += `> ${msg}<br>`;
        el.scrollTop = el.scrollHeight;
        console.log(msg);
    }

    // é…åˆ—ã‚’16é€²æ–‡å­—åˆ—ã«å¤‰æ›
    function toHex(dataView) {
        return [...new Uint8Array(dataView.buffer || dataView)]
            .map(b => b.toString(16).padStart(2, '0').toUpperCase())
            .join(' ');
    }

    document.getElementById('connectBtn').addEventListener('click', async () => {
        try {
            // 1. ãƒ‡ãƒã‚¤ã‚¹æ¥ç¶š
            device = await navigator.usb.requestDevice({ filters: [{ vendorId: SONY_VENDOR_ID }] });
            await device.open();
            await device.selectConfiguration(1);
            await device.claimInterface(0);
            log(`æ¥ç¶šå®Œäº†: ${device.productName}`);

            // 2. FeliCa Polling (ã‚«ãƒ¼ãƒ‰æ•æ‰)
            // System Code: FFFF (Wildcard), TimeSlot: 0
            const pollingCmd = [0x00, 0xFF, 0xFF, 0x00, 0x00]; 
            const pollingRes = await sendFeliCaCommand(pollingCmd);
            
            if (!pollingRes || pollingRes.getUint8(0) === 0) {
                throw new Error("Pollingå¤±æ•—: ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            }
            
            // IDmå–å¾— (Pollingãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®2ãƒã‚¤ãƒˆç›®ã‹ã‚‰8ãƒã‚¤ãƒˆåˆ†)
            // Response format: [ResponseCode(1)] [IDm(8)] [PMm(8)] ...
            const idm = new Uint8Array(pollingRes.buffer.slice(2, 10));
            log(`IDmæ¤œçŸ¥: ${toHex(idm)}`);

            // 3. Read Without Encryption (èª­ã¿å–ã‚Š)
            // Service Code: 0x898F (Little Endian -> 8F 89)
            // Block: 0
            const serviceCode = [0x8F, 0x89]; 
            const blockList = [0x80, 0x00]; // 2byte block list element (Access Mode:0, Service Index:0, Block:0)

            // Cmd(06) + IDm(8) + NumService(1) + ServiceCode(2) + NumBlock(1) + BlockList(2)
            const readCmd = new Uint8Array([
                0x06, 
                ...idm, 
                0x01, // ã‚µãƒ¼ãƒ“ã‚¹æ•°
                ...serviceCode, 
                0x01, // ãƒ–ãƒ­ãƒƒã‚¯æ•°
                ...blockList
            ]);

            const readRes = await sendFeliCaCommand(readCmd);

            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ
            // Format: [ResponseCode(1)] [IDm(8)] [Status1(1)] [Status2(1)] [BlockNum(1)] [BlockData(16*n)]
            if (readRes.getUint8(10) === 0x00 && readRes.getUint8(11) === 0x00) {
                // æˆåŠŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                const blockData = new DataView(readRes.buffer.slice(13, 13 + 16));
                const byte0 = blockData.getUint8(0);
                const byte1 = blockData.getUint8(1);
                
                // Big Endianè¨ˆç®— (byte0 * 256 + byte1)
                const val = (byte0 * 256) + byte1;
                
                document.getElementById('balanceValue').textContent = val.toLocaleString();
                document.getElementById('rawHex').textContent = toHex(blockData).substring(0, 5) + "...";
                document.getElementById('resultArea').style.display = 'block';
                log(`èª­ã¿å–ã‚ŠæˆåŠŸ! Raw: ${toHex(blockData)}`);
            } else {
                throw new Error(`èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ (Status: ${readRes.getUint8(10).toString(16)} ${readRes.getUint8(11).toString(16)})`);
            }

        } catch (e) {
            log(`ã‚¨ãƒ©ãƒ¼: ${e.message}`);
            alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n" + e.message);
        } finally {
            if (device && device.opened) {
                await device.close();
            }
        }
    });

    // PaSoRi RC-S380ã¸ã®ä½ãƒ¬ãƒ™ãƒ«ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ãƒ©ãƒƒãƒ‘ãƒ¼
    async function sendFeliCaCommand(commandBytes) {
        if (!device) return null;

        // RC-S380ç”¨ã®ãƒ˜ãƒƒãƒ€æ§‹ç¯‰ (transparent command)
        // PC -> Reader: [Header] [FeliCa Command]
        const dataLen = commandBytes.length;
        // S380 specific command wrapper for "Communicate Thru"
        const wrapper = new Uint8Array(dataLen + 5);
        // Header for "send data to card"
        wrapper.set([0xFF, 0x50, 0x00, 0x00, 0x02], 0); 
        // æœ¬æ¥ã¯ã‚‚ã£ã¨è¤‡é›‘ãªãƒ‘ã‚±ãƒƒãƒˆæ§‹é€ ã§ã™ãŒã€S380ã®ç°¡æ˜“ãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯é€éé€ä¿¡ã‚’æƒ³å®š
        // â€»å³å¯†ã«ã¯ACKãƒã‚§ãƒƒã‚¯ãªã©ãŒå¿…è¦ã§ã™ãŒã€ç°¡ç•¥åŒ–ã—ã¦ã„ã¾ã™
        
        /* * æ³¨æ„: RC-S380ã®WebUSBåˆ¶å¾¡ã¯å…¬å¼ä»•æ§˜ãŒå…¬é–‹ã•ã‚Œã¦ãŠã‚‰ãšã€
         * ä¸€èˆ¬çš„ãªã€Œnfc-felicaã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç­‰ã®æŒ™å‹•ã‚’æ¨¡å€£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
         * ã“ã“ã§ã¯å˜ç´”åŒ–ã®ãŸã‚ã€ã€ŒFeliCaã‚³ãƒãƒ³ãƒ‰ãƒ‘ã‚±ãƒƒãƒˆãã®ã‚‚ã®ã€ã‚’ä½œæˆã—ã€
         * å¿…è¦ãªãƒã‚§ãƒƒã‚¯ã‚µãƒ ãªã©ã‚’ä»˜ä¸ã—ã¦é€ä¿¡ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ã§ã™ã€‚
         * * ä»¥ä¸‹ã¯ã€JavaScriptã®ã¿ã§å®Œçµã•ã›ã‚‹ãŸã‚ã®ç°¡æ˜“ãƒ‰ãƒ©ã‚¤ãƒãƒ­ã‚¸ãƒƒã‚¯ã§ã™ã€‚
         */

        // æœ¬å½“ã«é€ä¿¡ã™ã‚‹ãƒ‘ã‚±ãƒƒãƒˆï¼ˆLen + Commandï¼‰
        const packet = new Uint8Array(commandBytes.length + 1);
        packet[0] = commandBytes.length + 1; // Length byte
        packet.set(commandBytes, 1);

        // RC-S380ã¸ã®é€ä¿¡ (Bulk Transfer Out)
        // Endpoint 2 is usually OUT for S380
        // å®Ÿéš›ã«ã¯ã‚³ãƒãƒ³ãƒ‰ã”ã¨ã«Ackå¾…ã¡ãªã©ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹åˆ¶å¾¡ãŒå¿…è¦ã§ã™ãŒã€
        // ã“ã“ã§ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ä¾å­˜ã—ãªã„æ¦‚å¿µã‚³ãƒ¼ãƒ‰ã¨ã—ã¦è¨˜è¿°ã—ã¾ã™ã€‚
        
        // â€»å®Ÿç”¨ã«ã¯ 'web-nfc-felica' ç­‰ã®npmãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä½¿ç”¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚
        // ã“ã®ã‚³ãƒ¼ãƒ‰å˜ä½“ã§ã¯ã€S380ã®åˆæœŸåŒ–ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚
        // ç’°å¢ƒã«ã‚ˆã£ã¦ã¯å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
        
        // ã“ã“ã§ã¯ã€Œé€ä¿¡ã™ã¹ããƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã€ã®æ§‹ç¯‰ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¤ºã—ã¾ã—ãŸã€‚
        // å®Ÿè£…æ™‚ã¯ https://github.com/google/web-nfc-felica ãªã©ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
        
        // ç°¡æ˜“çš„ãªå®Ÿè£…ã®ä»£ã‚ã‚Šã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã¾ã™
        log("æ³¨æ„: å®Œå…¨ãªãƒ‰ãƒ©ã‚¤ãƒå®Ÿè£…ã¯é•·å¤§ã«ãªã‚‹ãŸã‚ã€å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ã§ã™ã€‚");
        log("é€ä¿¡ã—ã‚ˆã†ã¨ã—ãŸã‚³ãƒãƒ³ãƒ‰: " + toHex(packet));
        
        // é–‹ç™ºç”¨ãƒ¢ãƒƒã‚¯ï¼ˆå®Ÿéš›ã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹ã¦ã„ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ï¼‰
        // ------------------------------------------------
        // Pollingã®å ´åˆ
        if (commandBytes[0] === 0x00) {
             // Dummy IDm response
             const dummyRes = new Uint8Array([0x1D, 0x01, 0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00]);
             return new DataView(dummyRes.buffer);
        }
        // Readã®å ´åˆ
        if (commandBytes[0] === 0x06) {
             // Dummy Block Data (02 DA ...)
             const dummyRes = new Uint8Array([
                 0x1D, 0x07, 
                 0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF, // IDm
                 0x00, 0x00, // Status Flag (Success)
                 0x01, // Block Num
                 0x02, 0xDA, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, // Data
                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
             ]);
             return new DataView(dummyRes.buffer);
        }
        // ------------------------------------------------
        
        return null;
    }
</script>
</body>
</html>